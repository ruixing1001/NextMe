---
title: 'Blog Image Optimization'
publishedAt: '2024-08-22'
summary: 'Image Optimization'
image: '/blog-img/image-optimization/cover.webp'
rssImage: '/blog-img/image-optimization/cover.jpeg'
category: 'Tech'
ai: 'åšå®¢åˆ†äº«äº†å¦‚ä½•é€šè¿‡ä¼˜åŒ–å›¾ç‰‡åŠ è½½å’Œç¼“å­˜æ¥æå‡åšå®¢é¡µé¢çš„ç”¨æˆ·ä½“éªŒä¸æ„å»ºé€Ÿåº¦ã€‚'
---

## å‰è¨€

åœ¨åšå®¢ä¸­ï¼Œå›¾ç‰‡çš„ä¼˜åŒ–æ˜¯éå¸¸å€¼å¾—è®¨è®ºçš„è¯é¢˜ã€‚

åœ¨é’ˆå¯¹æ­¤åšå®¢ç«™ç‚¹ä¸­çš„å›¾ç‰‡ç»„ä»¶è¿›è¡Œä¼˜åŒ–æŠ˜è…¾åï¼Œ

è¿™ç¯‡åšå®¢å°†é’ˆå¯¹

- æ„å»ºæ—¶ä¼˜åŒ–å›¾ç‰‡
- ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º

è¿™ä¸¤ä¸ªæ–¹é¢è¿›è¡Œä¸€äº›åˆ†äº«ã€‚

## ä¼˜åŒ–ç›®æ ‡

åœ¨ç½‘é¡µæµè§ˆä¸­ï¼Œç´¯è®¡å¸ƒå±€åç§»(CLS)å¸¸å¸¸ä¼šå¼•èµ·ä¸å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

[Cumulative Layout Shift (CLS) Â Â |Â  Articles Â Â |Â  web.dev](https://web.dev/articles/cls?hl=zh-cn)

è€Œåœ¨åšå®¢é¡µé¢ä¸­ï¼Œå›¾ç‰‡çš„åŠ è½½å¾€å¾€ä¼šå¼•èµ·è¿™ç§ç°è±¡ã€‚

![alt: å›¾ç‰‡åŠ è½½å¯¼è‡´çš„å¸ƒå±€åç§»](/blog-img/image-optimization/CleanShot_2024-08-22_at_11.23.04.gif)

ä»åŠ¨å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå½“é¡µé¢åŠ è½½å®Œæˆæ—¶ï¼Œå›¾ç‰‡å°šæœªåŠ è½½å®Œæˆï¼Œå¹¶ä¸”æ²¡æœ‰å®½åº¦ä¸é«˜åº¦çš„ä¿¡æ¯ï¼Œå› æ­¤åœ¨å›¾ç‰‡å®ŒæˆåŠ è½½åï¼Œå›¾ç‰‡å¦‚åŒçªç„¶å‡ºç°ä¸€æ ·ï¼Œå¹¶ä¸”ä¼šå°†æ‰€åœ¨ä½ç½®æ’‘å¼€ï¼Œå¯¼è‡´äº†å¸ƒå±€åç§»ã€‚

è¿™æ ·å­ä¼šç»™ç”¨æˆ·å¸¦æ¥éå¸¸ä¸å¥½çš„ç”¨æˆ·ä½“éªŒï¼š

1. å›¾ç‰‡åŠ è½½æ²¡æœ‰è¿‡æ¸¡ï¼Œè§†è§‰ä½“éªŒä¸å¥½ã€‚
2. åœ¨å¼±ç½‘ç¯å¢ƒä¸‹ï¼Œç”¨æˆ·æ— æ³•çŸ¥é“æ˜¯å¦å­˜åœ¨å›¾ç‰‡ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥ä»ä¸‰æ–¹é¢å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

- **è·å–å›¾ç‰‡çš„å…ƒä¿¡æ¯**ï¼Œè·å–å®½é«˜ç­‰å¿…éœ€ä¿¡æ¯ã€‚
- **ä¸ºå›¾ç‰‡ç”Ÿæˆå ä½ç¬¦**ï¼Œå¹¶ç»™å›¾ç‰‡åŠ è½½å®ŒæˆåŠ ä¸ŠåŠ¨ç”»ã€‚
- **å‹ç¼©å›¾ç‰‡**ï¼Œåœ¨ä¿è¯å›¾ç‰‡è´¨é‡çš„åŒæ—¶é™ä½å¸¦å®½å‹åŠ›ã€‚

## é¡¹ç›®æ¶æ„

é¦–å…ˆï¼Œç›®å‰çš„åšå®¢æ¶æ„ä¸‹ï¼Œæ¯ä¸ªåšå®¢é¡µé¢éƒ½æ˜¯åœ¨æ„å»ºçš„æ—¶å€™è¿›è¡Œç‹¬ç«‹ç”Ÿæˆé™æ€é¡µé¢ï¼ŒåŸç†æ˜¯ä½¿ç”¨ Next.js ä¸­çš„ generateStaticParams ã€‚

```go
export async function generateStaticParams() {
  let getPost = getBlogPosts()
  getPost = getPost.filter((post) => post.metadata.category !== 'Daily')

  return getPost.map((post) => ({
    slug: post.slug,
  }))
}
```

åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæ„å»ºå™¨å°†ä¼šé’ˆå¯¹æ¯ä¸€ä¸ªåšå®¢é¡µé¢ï¼Œé€šè¿‡ **_next-mdx-remote_** å°† markdown æ–‡ä»¶è½¬åŒ–ä¸ºç»„ä»¶æ ‘ã€‚

```go
let components = {
  h1: CreateHeading(1),
  h2: CreateHeading(2),
  h3: CreateHeading(3),
  h4: CreateHeading(4),
  h5: CreateHeading(5),
  h6: CreateHeading(6),
  img: CenterImage,
  a: CustomLink,
  Callout,
  ProsCard,
  ConsCard,
  code: Code,
  Table,
  TechCard,
}

export function CustomMDX(props) {
  return (
    <MDXRemote
      {...props}
      components={{ ...components, ...(props.components || {}) }}
    />
  )
}

```

å…·ä½“å¯å‚è€ƒå¾€æœŸæ–‡ç« ï¼š

[2024 Blog Refresh](https://buycoffee.top/blog/tech/blog-2024)

åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæ„å»ºå™¨ä¼šå°† md æ–‡ä»¶ä¸­çš„å›¾ç‰‡è½¬åŒ–ä¸ºè‡ªå®šä¹‰çš„å›¾ç‰‡ç»„ä»¶ã€‚

```go
![Code page (1).png](</blog-img/blog-2024/Code_page_(1).png>)

async function CenterImage(props: { src: string; alt: string })
```

æ„å»ºå™¨ä¼šå°†å›¾ç‰‡è·¯å¾„ä¸å›¾ç‰‡åä¼ å…¥åˆ°è‡ªå®šä¹‰ç»„ä»¶ä¸­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸­è¿›è¡Œå¯¹å›¾ç‰‡çš„ä¼˜åŒ–ã€‚

ä¼˜åŒ–åŒ…å«**ç”Ÿæˆå ä½ç¬¦**ï¼Œ**è·å–å›¾ç‰‡å…ƒä¿¡æ¯**ä¸**å‹ç¼©ä¼˜åŒ–å›¾ç‰‡**ä¸‰ä¸ªæ­¥éª¤ã€‚

ä»æ•´ä½“æ¥çœ‹ï¼Œå¯ä»¥å°†è¿‡ç¨‹ç®€åŒ–ä¸ºï¼š

![alt: å›¾ç‰‡æ„å»ºæ—¶ä¼˜åŒ–è¿‡ç¨‹](/blog-img/image-optimization/Frame_13.png)

### ç”Ÿæˆå ä½ç¬¦

æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Plaiceholder åº“æ¥å¿«é€Ÿä¸ºå›¾ç‰‡ç”Ÿæˆå ä½ç¬¦ã€‚

[Plaiceholder](https://plaiceholder.co/docs)

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œé‡‡ç”¨æå–å›¾ç‰‡é¢œè‰²çš„æ–¹å¼ï¼Œå°†é¢œè‰²ä½œä¸º div èƒŒæ™¯é¢œè‰²çš„æ–¹å¼ä½œä¸ºå ä½ç¬¦ã€‚

### è·å–å›¾ç‰‡å…ƒä¿¡æ¯

åœ¨è·å–å ä½ç¬¦çš„åŒæ—¶ï¼Œå°†å›¾ç‰‡æ–‡ä»¶çš„ metadata ä¹Ÿæå–å‡ºæ¥ï¼Œå…¶ä¸­åŒ…å«äº†å›¾ç‰‡çš„å®½é«˜ä¿¡æ¯ï¼Œè¿™æ˜¯é¿å…å¸ƒå±€åç§»çš„æ ¸å¿ƒå‚æ•°ã€‚

![ray-so-export.png](/blog-img/image-optimization/ray-so-export.png)

æœ€ç»ˆå°†å›¾ç‰‡ä¿¡æ¯ä¸å ä½ç¬¦ä¿¡æ¯ä½œä¸ºä¸€ä¸ªå¯¹è±¡è¿”å›åˆ°ç»„ä»¶ä¸­ã€‚

### æ„å»ºåšå®¢å›¾ç‰‡ç»„ä»¶

ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»è·å–åˆ°äº†å›¾ç‰‡çš„å®½é«˜ä¿¡æ¯ä»¥åŠå ä½ç¬¦æ‰€éœ€è¦çš„é¢œè‰²ä¿¡æ¯ï¼Œé€šè¿‡æ„å»ºä¸€ä¸ªå®¢æˆ·ç«¯çš„å›¾ç‰‡ç»„ä»¶ï¼Œå°±å¯ä»¥å°†ä¿¡æ¯ç»„åˆèµ·æ¥ï¼Œå¹¶æ­é…ä¸Šå›¾ç‰‡çš„åŠ è½½åŠ¨ç”»ã€‚

> åŠ¨ç”»çµæ„Ÿæ¥æºäºï¼š[https://www.youtube.com/watch?v=7hS9b6n7HrM&t=271s](https://www.youtube.com/watch?v=7hS9b6n7HrM&t=271s)

```go
const [isLoading, setIsLoading] = useState(true)

<div
  className="absolute inset-0 rounded-lg"
  style={{ backgroundColor: hex }}
/>
<img
  className={cn('relative h-full w-full rounded-lg border border-solid border-neutral-200 object-cover transition-all duration-500 dark:border-neutral-800 dark:brightness-75 dark:hover:brightness-100',
          isLoading ? 'opacity-0 blur-lg' : 'opacity-100 blur-0')}
  width={width}
  height={height}
  alt={alt}
  src={src}
  onLoad={() => setIsLoading(false)}
/>
```

é€šè¿‡ä¸€ä¸ª div é…åˆ backgroundColor çš„è®¾ç½®å³å¯ä¸ºå›¾ç‰‡å¢åŠ é¢œè‰²å ä½ç¬¦ï¼Œè€Œå ä½ç¬¦çš„å®½é«˜åˆ™å–å†³äºå›¾ç‰‡çš„å®½é«˜ï¼Œå…ˆå‰åœ¨å…ƒä¿¡æ¯ä¸­æå–åˆ°çš„å®½é«˜ä¿¡æ¯å³å¯åœ¨æ­¤ä½¿ç”¨ã€‚

åœ¨æ„å»ºæ—¶è·å–å›¾ç‰‡ä¿¡æ¯å¹¶è®¾ç½®å¥½å®½é«˜æ•°æ®ï¼Œå¯ç›´æ¥é¿å…äº†å›¾ç‰‡ä»æœªåŠ è½½åˆ°åŠ è½½åæ‰€é€ æˆçš„å¸ƒå±€åç§»ã€‚

åœ¨ Next.js ä¸­ï¼Œ'next/imageâ€™ ä¹Ÿæ˜¯é€šè¿‡åˆ†æé™æ€å¯¼å…¥å›¾ç‰‡çš„å®½é«˜è¿›è¡Œæå‰è®¾ç½®ï¼Œä»è€Œé¿å…å¸ƒå±€åç§»çš„å‘ç”Ÿã€‚

[Optimizing: Images](https://nextjs.org/docs/app/building-your-application/optimizing/images)

åœ¨å›¾ç‰‡æœªåŠ è½½å®Œå…¨æ—¶ï¼Œæ•ˆæœä¸ºä¸€ä¸ªç±»ä¼¼è‰²å—çš„å ä½ç¬¦ã€‚

![alt: å›¾ç‰‡æœªåŠ è½½å®ŒæˆçŠ¶æ€](/blog-img/image-optimization/CleanShot_2024-08-22_at_14.16.252x.png)

æ­¤å¤–ï¼Œé€šè¿‡æ­é… onLoad å‡½æ•°ï¼Œå¯ä»¥åœ¨å›¾ç‰‡åŠ è½½å®Œæˆåè¿›è¡Œä¸€äº›åç»­æ“ä½œã€‚ä½¿ç”¨ useState åœ¨è®°å½•å›¾ç‰‡çš„åŠ è½½çŠ¶æ€ï¼Œæ­é… css ä¸­çš„ transitionã€opacity ä¸ blur å‚æ•°ï¼Œå¯ä»¥åœ¨å›¾ç‰‡å®ŒæˆåŠ è½½åï¼Œåˆ›å»ºä¸€ä¸ªæµç•…çš„è¿‡æ¸¡æ•ˆæœã€‚

![CleanShot 2024-08-22 at 14.26.50.gif](/blog-img/image-optimization/CleanShot_2024-08-22_at_14.26.50.gif)

å®Œæ•´åšå®¢å›¾ç‰‡ç»„ä»¶å‚è€ƒä»£ç å¦‚ä¸‹ï¼š

[blog-image.tsx](https://gist.github.com/é‚µç‘æ˜Ÿå’Œæ‰£å¸…ç”·/5c848e47f69d049fb869e375170fc467)

è‡³æ­¤ï¼Œå¯¹äºå¸ƒå±€åç§»çš„å›¾ç‰‡åŠ è½½ä¼˜åŒ–çš„è¿‡ç¨‹å°±å…ˆå‘Šä¸€æ®µè½äº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹äºå›¾ç‰‡å¤§å°è¿›è¡Œä¼˜åŒ–ã€‚

### å›¾ç‰‡å¤§å°ä¼˜åŒ–

å¯¹äºå›¾ç‰‡ä¼˜åŒ–ï¼Œæœ‰è®¸å¤šä¸åŒçš„æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ä¼˜åŒ– APIï¼Œæ¯”å¦‚

- Vercel Image Optimization

[Image Optimization with Vercel](https://vercel.com/docs/image-optimization)

- Cloudflare Image Optimization

[Overview | Cloudflare Image Optimization docs](https://developers.cloudflare.com/images/)

- Cloudinary

[Image and Video Upload, Storage, Optimization and CDN](https://cloudinary.com/)

è¿™äº›äº§å“éƒ½æä¾›å¯¹å›¾ç‰‡ä¼˜åŒ–çš„ API æœåŠ¡ï¼Œåœ¨å°‘é‡å›¾ç‰‡çš„æƒ…å†µä¸‹ï¼Œé€‰ç”¨è¿™äº›äº§å“ä¹Ÿå¯å¿«é€Ÿä¼˜åŒ–å›¾ç‰‡ã€‚

ä½†æ˜¯å¯¹äºåšå®¢ç«™ç‚¹æ¥è¯´ï¼Œå¾€å¾€å›¾ç‰‡çš„æ•°é‡å¹¶ä¸å¯æ§ï¼Œå¹¶ä¸”éšç€åšå®¢æ–‡ç« æ•°é‡çš„å¢åŠ ï¼Œå›¾ç‰‡çš„æ•°é‡ä¹Ÿä¼šæŒ‡æ•°çº§ä¸Šæ¶¨ï¼Œå› æ­¤åœ¨æœ¬åœ°æ„å»ºæ—¶å¯¹å›¾åƒè¿›è¡Œä¼˜åŒ–ï¼Œä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„æ–¹æ¡ˆã€‚

åœ¨ Next.js ä¸­ï¼Œå†…ç½®äº†å›¾ç‰‡ä¼˜åŒ–çš„æ–¹å¼ï¼Œé€šè¿‡ \_next/image è·¯å¾„å³å¯é’ˆå¯¹å›¾ç‰‡è¿›è¡Œä¼˜åŒ–ï¼Œä½†å¯¹äºå°šå­˜å‚¨åœ¨æœ¬åœ°çš„å›¾ç‰‡æ¥è¯´ï¼Œè¿™ç§æ–¹å¼å¹¶ä¸å¯ç”¨ã€‚

ä½†å…¶å†…æ ¸ä¸­ï¼Œ å›¾ç‰‡ä¼˜åŒ–æ˜¯é‡‡ç”¨ sharp åº“å»è¿›è¡Œä¼˜åŒ–å›¾ç‰‡çš„æµç¨‹çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ„å»ºæ—¶ä½¿ç”¨ sharp é’ˆå¯¹åšå®¢å†…å›¾ç‰‡è¿›è¡Œä¼˜åŒ–ã€‚

```go
const originalBuffer = await getFileBufferLocal(imagePath)
const optimizedBuffer = await sharp(originalBuffer)
      .resize(1920, 1080, { fit: 'inside', withoutEnlargement: true })
      .webp({ quality: 90, lossless: true })
      .toBuffer()
```

åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¯»å–æœ¬åœ°å›¾ç‰‡æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ sharp å°†å…¶è½¬åŒ–ä¸º webp æ ¼å¼ï¼ˆå¯å¤§å¤§é™ä½å›¾ç‰‡å¤§å°ï¼‰ï¼Œå¹¶é€šè¿‡è®¾ç½® lossless ä¸ qualityï¼Œä¿è¯å›¾ç‰‡è´¨é‡ä¸ä¼šå—åˆ°å¤ªå¤§ç¨‹åº¦çš„è¡°å‡ã€‚

åœ¨ä¼˜åŒ–åï¼Œé‡æ–°å°†å…¶å­˜å‚¨åˆ° public æ–‡ä»¶å¤¹ä¸­ï¼Œä¼ é€’æ–°çš„å›¾ç‰‡è·¯å¾„ç»™åšå®¢å›¾ç‰‡ç»„ä»¶ã€‚

```go
// ä¿å­˜ä¼˜åŒ–åçš„å›¾ç‰‡åˆ° public ç›®å½•
await fs.writeFile(publicPath, optimizedBuffer)
```

ä¸€åˆ‡å°±ç»ªï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„å»ºå§ã€‚

![CleanShot 2024-08-22 at 15.07.24@2x.png](/blog-img/image-optimization/CleanShot_2024-08-22_at_15.07.242x.png)

åœ¨ç»è¿‡å‡ æ¬¡æ„å»ºåï¼Œå°±ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œæ„å»ºæ—¶é—´çœŸçš„æ˜¯å¤ªé•¿äº†ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å°†ä¼šé’ˆå¯¹æœ€åä¸€ä¸ªé—®é¢˜ï¼š**æ„å»ºæ€§èƒ½**ï¼Œè¿›è¡Œä¼˜åŒ–ã€‚

## æ„å»ºæ€§èƒ½ä¼˜åŒ–

ç›®å‰ï¼Œæ²¡æœ‰åšä»»ä½•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æ„å»ºä¸­ï¼Œéƒ½ä¼šé’ˆå¯¹æ¯ä¸€å¼ å›¾ç‰‡è¿›è¡Œä¸Šè¿°çš„ä¼˜åŒ–æµç¨‹

1. è·å–å ä½ç¬¦ä¸å…ƒä¿¡æ¯
2. ç”Ÿæˆä¼˜åŒ–åå›¾ç‰‡

å› æ­¤ï¼Œæ¯æ¬¡æ„å»ºä¸­å…¶å®éƒ½åœ¨é‡å¤é’ˆå¯¹å›¾ç‰‡è¿›è¡Œä¼˜åŒ–ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥å°†å·²ç»ä¼˜åŒ–è¿‡çš„å›¾ç‰‡ä¸ä¿¡æ¯ç¼“å­˜èµ·æ¥ï¼Œåœ¨ä¸‹æ¬¡æ„å»ºæ—¶ä»é¦–å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œä¸å­˜åœ¨åˆ™å†è¿›è¡Œä¼˜åŒ–ã€‚

<aside>
ğŸ’¡ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒNext.js çš„æ„å»ºç¼“å­˜è·¯å¾„ä¸º **.next/cache/****

</aside>

æˆ‘ä»¬å°†æå–çš„å ä½ç¬¦ä¸å…ƒä¿¡æ¯ã€ä¼˜åŒ–åçš„å›¾ç‰‡ä¸€èµ·å­˜å‚¨åˆ°ç¼“å­˜ä¸­ã€‚

å…¶ä¸­ï¼Œæ–‡ä»¶åé‡‡ç”¨å›¾ç‰‡è·¯å¾„ç”Ÿæˆçš„ MD5 å€¼ã€‚

```go
// ä½¿ç”¨æ–‡ä»¶è·¯å¾„ç”Ÿæˆ MD5 å“ˆå¸Œå€¼
const contentHash = crypto.createHash('md5').update(imagePath).digest('hex')
const cacheDir = path.join(
    process.cwd(),
    '.next',
    'cache',
    'optimized-images'
  )
const placeholderCacheFileName = `${contentHash}-placeholder.json`
const placeholderCachePath = path.join(cacheDir, placeholderCacheFileName)
// ä¿å­˜å ä½å›¾ä¿¡æ¯åˆ°ç¼“å­˜
await fs.mkdir(cacheDir, { recursive: true })
await fs.writeFile(placeholderCachePath, JSON.stringify(preImage))

// ä¿å­˜ä¼˜åŒ–åçš„å›¾ç‰‡åˆ°ç¼“å­˜ç›®å½•å’Œ public ç›®å½•
await fs.writeFile(cachePath, optimizedBuffer)
await fs.writeFile(publicPath, optimizedBuffer)
```

åœ¨æ„å»ºæ—¶ï¼Œåœ¨ç¼“å­˜ä¸­æ£€ç´¢åˆ°ç›¸åŒæ–‡ä»¶åçš„å›¾ç‰‡æ—¶ï¼Œå°±å¯ä»¥å°†å…¶å†™å…¥åˆ° public æ–‡ä»¶å¤¹ä¸­ã€‚

```go
// å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œå°†å…¶å¤åˆ¶åˆ° public ç›®å½•
await fs.mkdir(publicDir, { recursive: true })
await fs.copyFile(cachePath, publicPath)
